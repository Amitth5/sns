<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/underscore@latest/underscore-umd-min.js"></script>


<div class="container" style="margin-top: 50px;">


  <!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter">
  Todays Records
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Enter Todays Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label for="exampleInputEmail1">Customer Name</label>
          <input type="text" class="form-control" id="customer_name"  placeholder="Customer Name">
      </div>
      
      
      <div class="form-group">
          <label for="exampleInputEmail1">Restaurant Name</label>
          <input type="text" class="form-control" id="resto_name"  placeholder="Restaurant Name">
      </div>
      
      <div class="form-group">
          <label for="exampleFormControlSelect1">Select Delivery Boy</label>
          <select class="form-control" id="delivery_boy">

              <option value="96">Amit</option>
              <option value="674">Krishna</option>
              <option value="1084">Rahul Parmar</option>
              <option value="885">Sameer</option>
              <option value="1697">Subhash</option>
              <option value="1551">Sunil</option>
              <option value="97">Vinay Salve</option>

      
          </select>
      </div>
      
      <div class="form-group">
          <label for="exampleInputEmail1">Amount</label>
          <input type="text" class="form-control" id="amount"  placeholder="Amount">
      </div>
      
      <div class="form-group">
          <label for="exampleInputEmail1">Transaction Date</label>
          <input type="date" class="form-control" id="transaction_date"  placeholder="Date">
      </div>
      
      <div class="form-group">
          <label for="exampleFormControlSelect1">Status</label>
          <select class="form-control" id="status">
            <option value="1">Pending</option>
            <option value="2">Offline Order</option>
            <option value="3">Hotel Payment</option>
            <option value="4">Refund</option>
            <option value="5">Payment to Amit</option>
            <option value="6">Order Cancel</option>
          </select>
      </div>
      
      <div class="form-group">
          <label for="exampleFormControlTextarea1">Description</label>
          <textarea class="form-control" id="description" rows="3"></textarea>
      </div>
      </div>
      <div class="form-group">
        <div class="alert alert-danger"> Please fill all the details</div>
        <div class="alert alert-info"> Data saved !!</div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" id="submit" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

    <div class="container fluid pull-left">
        <form method ="GET" action="http://3.94.170.142/transaction">
            <label for="birthday">Select Date:</label>
            <input type="date" id="date" name="date" class="form-control">
            <input type="submit" class="btn btn-info">
        </form>
    </div>




</div>

<div class="container fluid" style="margin-top:20px;">
    <h2>Total Sale: <%= data.totalOrderValue %> </h2>
    <h2>Total Delivery Deduction Deduction: <%=  data.deliveryDeduction  %></h2>
    <h2 style="color:green"> Rahul Release Payment: <%= data.rahulReleasePayment  -  data.deliveryDeduction %> </h2>

  <!-- <% if(dname == 'sunil') { %>
    <h2>Total COD: <%= data.deliveryDetails[0]['COD'] %> </h2>
  <% } %> -->

<!-- <div class="deliveryGuyDetails">
  <h2>Actual COD : <span id="actualCod"></span> </h2>
  <h2>Delivery Partner: <span id="deliveryName"></span></h2>
  <h2>COD: <span style="color:green"  id="deliveryCod"></span></h2>

</div> -->

<table class="table table-striped">
  <thead>
    <tr>
      <th scope="col">Del P.</th>
      <th scope="col">Resto</th>
      <th scope="col">Customer</th>
      <th scope="col">Amt</th>
      <th scope="col">Status</th>
      <th scope="col">Delete</th>
    </tr>
  </thead>
  <tbody>
  
  <% transactionData.forEach(function(product) { %>
<tr>
<% if(product.delivery_id == 1084){ %>
  <td scope="row"> Rahul Parmar </td>
 <% } else if (product.delivery_id == 1551){ %>  
  <td scope="row"> Sunil </td>
 <% } else if (product.delivery_id == 1697){ %>  
   <td scope="row"> Subhash </td>
  <% } else if (product.delivery_id == 885){ %>  
     <td scope="row"> Sameer </td>
  <% } else if (product.delivery_id == 674){ %>  
     <td scope="row"> Krishna </td>
  <% } else if (product.delivery_id == 96){ %>  
     <td scope="row"> Amit </td>
  <% } else if (product.delivery_id == 2887){ %>  
      <td scope="row"> Patil Rahul </td>
  <% } else if (product.delivery_id == 2805){ %>  
        <td scope="row"> Bhagwan Dawane </td>
  <% }else { %>
    <td scope="row"> Other </td>
  <% } %>   


  
  <td> <%= product.restaurant_name %> </td>
  <td> <%= product.customer_name %> </td>
  <td> <%= product.amount %> </td>
   <% if(product.status == 1){ %>
    <td scope="row" class="status"> Pending </td>
   <% } else if (product.status == 2){ %>  
    <td scope="row" class="status"> Offline Order </td>
   <% } else if (product.status == 3){ %>  
    <td scope="row" class="status"> Hotel Payment </td>
    <% } else if (product.status == 4){ %>  
    <td scope="row" class="status"> Refund / Discount </td>
    <% } else if (product.status == 5){ %>  
    <td scope="row" class="status"> Payment to Amit </td>
    <% } else if (product.status == 6){ %>  
      <td scope="row" class="status"> Order Cancelled </td>
    <% } else if (product.status == 7){ %>  
        <td scope="row" class="status"> Pending Received </td>
    <% }  %> 
   <td>  <svg class="deleteRecord" data-id="<%= product.id %>" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
</svg> </td>

</tr>
<% }); %>
  </tbody>
</table>
</div>
<script>
    $(document).ready(function(){
      $('.alert-danger').hide();
      $('.alert-info').hide();

      var deliveryGuysDetails= {
      "sunil":{
                "name": "sunil",
                "id":1551
      },
      "subhash":{
        "name": "subhash",
        "id":1697,
      },
      "bhagwan":{
        "name":"Bhagwan",
        "id":2005,
      },
      "sameer":{
        "name": "Sameer",
        "id":885,
      },
      "rahulp":{
        "name": "Rahul Patil",
        "id":2887,  
      }
    };

      var data = '<%- JSON.stringify(data)  %>';
      var transactionData = '<%- JSON.stringify(transactionData)  %>';
      var dname = '<%- dname %>';
      console.log(dname);
      data = JSON.parse(data);
      transactionData = JSON.parse(transactionData);
      console.log(data);
      console.log(transactionData);
      
      var dDetails = data.deliveryDetails;
      console.log(dDetails);
      
      if(dname !== '000'){
        var deliveryDetails = _.where(dDetails, {'name':dname});
        var cod = deliveryDetails[0]['COD'];
        $('#actualCod').html(cod);
        if(deliveryDetails.length > 0){
          transactionData =  _.where(transactionData, {'delivery_id':deliveryGuysDetails[dname]['id']});
        _.map(transactionData, function(obj){ 
          if(obj.status != 2 ){
            if(obj.status != 7){
            cod = cod - parseInt(obj.amount);
            }
          }else{
            if(obj.status != 7){
            cod = cod +  parseInt(obj.amount);
            }
          }
         });

         $('#deliveryName').html(dname);
         $('#deliveryCod').html(cod);
        }

        console.log(deliveryDetails);
      }

        $('#submit').click(function(){
            var customer_name = $('#customer_name').val();
            var resto_name = $('#resto_name').val();
            var delivery_boy = $('#delivery_boy').find(":selected").val()
            var status = $('#status').find(":selected").val();
            var description = $('#description').val();
            var transaction_date = $('#transaction_date').val();
            var amount = $('#amount').val().trim();
            
            var postData = {"customer_name": customer_name, "resto_name": resto_name, "delivery_boy": delivery_boy, "status": status, "amount": amount, "description": description, "transaction_date": transaction_date}
           if(customer_name.trim() != "" && resto_name.trim() != "" && transaction_date != "" && amount.trim() !=""){
            $.get( "http://3.94.170.142/inserttransaction",{"data":postData}, function(res , statua) {
              $('.alert-info').show();
              $('#customer_name').val('');
              $('#resto_name').val('');
              $('#amount').val('');
              $('.alert-danger').hide();

            });
          }else{
            $('.alert-info').hide();
            $('.alert-danger').show();
          }
        });

        $(".deleteRecord").dblclick(function(){
          alert("The paragraph was double-clicked");
          var id =  $(this).attr('data-id');
          var _this = $(this);
          $.get( "http://3.94.170.142/deletetransaction",{"id":id}, function(res , status) {
            _this.closest('tr').hide();
            _this.closest('tr').show();
            _this.closest('tr').find('.status').html('Pending Received').css("font-weight", "500");
          });
        });
    });
</script>

<style>
  .form-group{
    margin-bottom: 15px;
  }
  .table{
  font-size: 12px !important;
  }
</style>
